---
title: 'Tutorial: Create a passwordless connection with Service Connector'
description: Create a passwordless connection with Service Connector
titleSuffix: Service Connector
author: mcleanbyron
ms.author: mcleans
ms.service: service-connector
ms.topic: tutorial
ms.date: 07/17/2023
ms.devlang: azurecli
ms.custom: passwordless-dotnet, passwordless-java
zone_pivot_group_filename: service-connector/zone-pivot-groups.json
zone_pivot_groups: passwordless
---

# Tutorial: Create a passwordless connection to a database service via Service Connector

Passwordless connections use managed identities to access Azure services. With this approach, you don't have to manually track and manage secrets for managed identities. These tasks are securely handled internally by Azure.

Service Connector enables managed identities in app hosting services like Azure Spring Apps, Azure App Service, and Azure Container Apps. Service Connector also configures database services, such as Azure Database for PostgreSQL, Azure Database for MySQL, and Azure SQL Database, to accept managed identities.

In this tutorial, you use the Azure CLI to complete the following tasks:

> [!div class="checklist"]
> * Check your initial environment with the Azure CLI.
> * Create a passwordless connection with Service Connector.
> * Use the environment variables or configurations generated by Service Connector to access a database service.

## Prerequisites

* [Azure CLI](/cli/azure/install-azure-cli) version 2.48.1 or higher.
* An Azure account with an active subscription. [Create an Azure account for free](https://azure.microsoft.com/free).
* An app deployed to [Azure App Service](../app-service/overview.md) in a [region supported by Service Connector](./concept-region-support.md).

### Set up environment

#### Account

Sign in with the Azure CLI via `az login`. If you're using Azure Cloud Shell or are already logged in, confirm your authenticated account with `az account show`.

#### Network connectivity

::: zone pivot="postgresql"

If your database server is in Virtual Network, ensure your environment that runs the Azure CLI command can access the server in the Virtual Network.

::: zone-end

::: zone pivot="mysql"

If your database server is in Virtual Network, ensure your environment that runs the Azure CLI command can access the server in the Virtual Network.

::: zone-end

::: zone pivot="sql"

If your database server disallows public access, ensure your environment that runs the Azure CLI command can access the server through the private endpoint.

::: zone-end

### Install the Service Connector passwordless extension

[!INCLUDE [CLI-samples-clean-up](./includes/install-passwordless-extension.md)]

## Create passwordless connection

Next, we use Azure App Service as an example to create a connection using managed identity. 

If you use:

* Azure Spring Apps, use `az spring connection create` instead. For more examples, see [Connect Azure Spring Apps to the Azure database](/azure/developer/java/spring-framework/deploy-passwordless-spring-database-app#connect-azure-spring-apps-to-the-azure-database). 
* Azure Container Apps, use `az containerapp connection create` instead. For more examples, see [Create and connect a PostgreSQL database with identity connectivity](../container-apps/tutorial-java-quarkus-connect-managed-identity-postgresql-database.md?tabs=flexible#5-create-and-connect-a-postgresql-database-with-identity-connectivity).

> [!NOTE]
> If you use the Azure portal, go to the **Service Connector** blade of [Azure App Service](./quickstart-portal-app-service-connection.md), [Azure Spring Apps](./quickstart-portal-spring-cloud-connection.md), or [Azure Container Apps](./quickstart-portal-container-apps.md), and select **Create** to create a connection. The Azure portal will automatically compose the command for you and trigger the command execution on Cloud Shell.

::: zone pivot="postgresql"

The following Azure CLI commands use a `--client-type` parameter. Run the `az webapp connection create postgres-flexible -h` to get the supported client types, and choose the one that matches your application.

### [User-assigned managed identity](#tab/user)

```azurecli
az webapp connection create postgres-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $POSTGRESQL_HOST \
    --database $DATABASE_NAME \
    --user-identity client-id=XX subs-id=XX \
    --client-type java
```

### [System-assigned managed identity](#tab/system)

```azurecli
az webapp connection create postgres-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $POSTGRESQL_HOST \
    --database $DATABASE_NAME \
    --system-identity \
    --client-type java
```

### [Service principal](#tab/sp)

```azurecli
az webapp connection create postgres-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $POSTGRESQL_HOST \
    --database $DATABASE_NAME \
    --service-principal client-id=XX secret=XX\
    --client-type java
```

::: zone-end


::: zone pivot="mysql"

Azure Database for MySQL - Flexible Server requires a user-assigned managed identity to enable Azure Active Directory authentication. For more information, see [Set up Azure Active Directory authentication for Azure Database for MySQL - Flexible Server](../mysql/flexible-server/how-to-azure-ad.md). You can use the following command to create a user-assigned managed identity:

```azurecli
USER_IDENTITY_NAME=<YOUR_USER_ASSIGNED_MANAGEMED_IDENTITY_NAME>
IDENTITY_RESOURCE_ID=$(az identity create \
    --name $USER_IDENTITY_NAME \
    --resource-group $RESOURCE_GROUP \
    --query id \
    --output tsv)
```

> [!IMPORTANT]
> After creating the user-assigned managed identity, ask your *Global Administrator* or *Privileged Role Administrator* to grant the following permissions for this identity:

* `User.Read.All`
* `GroupMember.Read.All`
* `Application.Read.All`

For more information, see the [Permissions](../mysql/flexible-server/concepts-azure-ad-authentication.md#permissions) section of [Active Directory authentication](../mysql/flexible-server/concepts-azure-ad-authentication.md).

Then, connect your app to a MySQL database with a system-assigned managed identity using Service Connector.

The following Azure CLI commands use a `--client-type` parameter. Run the `az webapp connection create mysql-flexible -h` to get the supported client types, and choose the one that matches your application.

### [User-assigned managed identity](#tab/user)

```azurecli
az webapp connection create mysql-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $MYSQL_HOST \
    --database $DATABASE_NAME \
    --user-identity client-id=XX subs-id=XX mysql-identity-id=$IDENTITY_RESOURCE_ID \
    --client-type java
```

### [System-assigned managed identity](#tab/system)

```azurecli
az webapp connection create mysql-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $MYSQL_HOST \
    --database $DATABASE_NAME \
    --system-identity mysql-identity-id=$IDENTITY_RESOURCE_ID \
    --client-type java
```

### [Service principal](#tab/sp)

```azurecli
az webapp connection create mysql-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $MYSQL_HOST \
    --database $DATABASE_NAME \
    --service-principal client-id=XX secret=XX mysql-identity-id=$IDENTITY_RESOURCE_ID \
    --client-type java
```

::: zone-end


::: zone pivot="sql"

The following Azure CLI commands use a `--client-type` parameter. Run the `az webapp connection create sql -h` to get the supported client types, and choose the one that matches your application.

### [User-assigned managed identity](#tab/user)

```azurecli
az webapp connection create sql \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $SQL_HOST \
    --database $DATABASE_NAME \
    --user-identity client-id=XX subs-id=XX \
    --client-type dotnet
```

### [System-assigned managed identity](#tab/system)

```azurecli
az webapp connection create sql \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $SQL_HOST \
    --database $DATABASE_NAME \
    --system-identity \
    --client-type dotnet
```

### [Service principal](#tab/sp)

```azurecli
az webapp connection create sql \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $SQL_HOST \
    --database $DATABASE_NAME \
    --service-principal client-id=XX secret=XX \
    --client-type dotnet
```

::: zone-end

This Service Connector command completes the following tasks in the background:

- Enable system-assigned managed identity, or assign a user identity for the app `$APPSERVICE_NAME` hosted by Azure App Service/Azure Spring Apps/Azure Container Apps.
- Set the Azure Active Directory admin to the current signed-in user.
- Add a database user for the system-assigned managed identity, user-assigned managed identity, or service principal. Grant all privileges of the database `$DATABASE_NAME` to this user. The username can be found in the connection string in preceding command output.
- Set configurations named `AZURE_MYSQL_CONNECTIONSTRING`, `AZURE_POSTGRESQL_CONNECTIONSTRING`, or `AZURE_SQL_CONNECTIONSTRING` to the Azure resource based on the database type. 
  - For App Service, the configurations are set in the **App Settings** blade.
  - For Spring Apps, the configurations are set when the application is launched.
  - For Container Apps, the configurations are set to the environment variables. You can get all configurations and their values in the **Service Connector** blade in the Azure portal.


### Troubleshooting

#### Permission

If you encounter any permission-related errors, confirm the Azure CLI signed-in user with the command `az account show`. Make sure you log in with the correct account. Next, confirm that you have the following permissions that may be required to create a passwordless connection with Service Connector.

::: zone pivot="postgresql"

| Permission | Operation |
| --- | --- |
| `Microsoft.DBforPostgreSQL/flexibleServers/read` | Required to get information of database server |
| `Microsoft.DBforPostgreSQL/flexibleServers/write` | Required to enable Azure AD authentication for database server |
| `Microsoft.DBforPostgreSQL/flexibleServers/firewallRules/write` | Required to create firewall rule in case the local IP address is blocked |
| `Microsoft.DBforPostgreSQL/flexibleServers/firewallRules/delete` | Required to revert the firewall rule created by Service Connector to avoid security issue |
| `Microsoft.DBforPostgreSQL/flexibleServers/administrators/read` | Required to check if Azure CLI login user is a database server Azure AD administrator |
| `Microsoft.DBforPostgreSQL/flexibleServers/administrators/write` | Required to add Azure CLI login user as database server Azure AD administrator |

::: zone-end

::: zone pivot="mysql"

| Permission | Operation |
| --- | --- |
| `Microsoft.DBforMySQL/flexibleServers/read` | Required to get information of database server |
| `Microsoft.DBforMySQL/flexibleServers/write` | Required to add the provided User assigned managed identity to database server |
| `Microsoft.DBforMySQL/flexibleServers/firewallRules/write` | Required to create firewall rule in case the local IP address is blocked |
| `Microsoft.DBforMySQL/flexibleServers/firewallRules/delete` | Required to revert the firewall rule created by Service Connector to avoid security issue |
| `Microsoft.DBforMySQL/flexibleServers/administrators/read` | Required to check if Azure CLI login user is a database server Azure AD administrator |
| `Microsoft.DBforMySQL/flexibleServers/administrators/write` | Required to add Azure CLI login user as database server Azure AD administrator |

::: zone-end


::: zone pivot="sql"

| Permission | Operation |
| --- | --- |
| `Microsoft.Sql/servers/read` | Required to get information of database server |
| `Microsoft.Sql/servers/firewallRules/write` | Required to create firewall rule in case the local IP address is blocked |
| `Microsoft.Sql/servers/firewallRules/delete` | Required to revert the firewall rule created by Service Connector to avoid security issue |
| `Microsoft.Sql/servers/administrators/read` | Required to check if Azure CLI login user is a database server Azure AD administrator |
| `Microsoft.Sql/servers/administrators/write` | Required to add Azure CLI login user as database server Azure AD administrator |

::: zone-end

In some cases, the permissions aren't required. For example, if the Azure CLI-authenticated user is already an Active Directory Administrator on SQL server, you don't need to have the `Microsoft.Sql/servers/administrators/write` permission.

#### Azure Active Directory

If you get an error `ERROR: AADSTS530003: Your device is required to be managed to access this resource.`, ask your IT department for help with joining this device to Azure Active Directory. For more information, see [Azure AD-joined devices](../active-directory/devices/concept-azure-ad-join.md).

Service Connector needs to access Azure Active Directory to get information of your account and managed identity of hosting service. You can use the following command to check if your device can access Azure Active Directory:

```azurecli
az ad signed-in-user show
```

If you don't log in interactively, you may also get the error and `Interactive authentication is needed`. To resolve the error, log in with the `az login` command.


## Connect to database with Azure Active Directory authentication

After creating the connection, you can use the connection string in your application to connect to the database with Azure Active Directory authentication. For example, you can use the following solutions to connect to the database with Azure Active Directory authentication.

:::zone pivot="postgresql"


[!INCLUDE [code sample for postgres aad connection](./includes/code-postgres-aad.md)]


:::zone-end

:::zone pivot="mysql"

[!INCLUDE [code sample for mysql aad connection](./includes/code-mysql-aad.md)]


:::zone-end


:::zone pivot="sql"

[!INCLUDE [code sample for sql aad connection](./includes/code-sql-aad.md)]


:::zone-end


## Deploy the application to an Azure hosting service

Finally, deploy your application to an Azure hosting service. That source service can use managed identity to connect to the target database on Azure.

### [App Service](#tab/appservice)

For Azure App Service, you can deploy the application code via the `az webapp deploy` command. For more information, see [Quickstart: Deploy an ASP.NET web app](../app-service/quickstart-dotnetcore.md).

### [Spring Apps](#tab/springapp)

For Azure Spring Apps, you can deploy the application code via the `az spring app deploy` command. For more information, see [Quickstart: Deploy your first application to Azure Spring Apps](../spring-apps/quickstart.md).

### [Container Apps](#tab/containerapp)

For Azure Container Apps, you can deploy the application code via the `az containerapp create` command. For more information, see [Quickstart: Deploy your first container app](../container-apps/get-started.md).

---

Then you can check the log or call the application to see if it can connect to the database on Azure successfully.

## Next steps

For more information about Service Connector and passwordless connections, see the following resources:

> [!div class="nextstepaction"]
> [Service Connector documentation](/azure/service-connector/)

> [!div class="nextstepaction"]
> [Passwordless connections for Azure services](/azure/developer/intro/passwordless-overview)
